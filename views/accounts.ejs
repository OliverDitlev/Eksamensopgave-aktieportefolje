<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PortofolioTracker</title>
    
    <%- include('partials/menu') %>
    <script src ="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script>
        const accounts = <%- JSON.stringify(accounts.map(a => ({ balance: a.balance, currency: a.currency }))) %>;
      </script>

    <link rel="stylesheet" href="/css/style.css">
 
</head>

<body id="main" class="main">
    <h1 class = "accounth1">Choose account</h1>
<button id = "openformbtn">Add account</button>
    <div id = "popupform" class="popup hidden">
        <div id = "insideform">       
            <span id="closeformbtn">X</span>

            <h2>Create account</h2>
            <form action="/accounts" method="post" id = "ledgerform">
                <label for="name">Account name</label>
                <input type="text" name="name" required>
                

                <label for="bank">Bank</label>
                <select name="bank">
                    <option value="Nordea">Nordea</option>
                    <option value="Danske Bank">Danske Bank</option>
                </select>

                <label for="balance"> Starting balance </label>
                <input type="number" name = "balance" required>
               

                <label for="currency">Currency</label>
                <select name="currency" id="choseCurrency">
                    <option value="DKK">DKK</option>
                    <option value="USD">USD</option>
            </select>
                
            <button type="submit" >Open account</button>
            
        </form>
        </div>
    </div>

    <!--her vises samlet tabel over kontoer-->
    <table class="accounttable">
        <tr class="thtable">
            <th>Name</th>
            <th>Bank</th>
            <th>Balance</th>
            <th>Last 24h</th>
            <th>Last week</th>
            
            
        </tr>
        
            <% accounts.forEach(value => { %>
        <tr>   
        
            <td><%= value.name %></td> 
            <td><%= value.bank %></td>
            <td><%= value.balance %> <%= value.currency %></td>
            <td>+2%</td>
            <td>+5%</td>

            <td>
            <button class="accountbtn">Change balance</button>
            <button class="accountbtn" id="deleteaccount">Delete account</button>
            </td>
    
        </tr>
            <%})%>
    </table>
    <!--her vises samlet belÃ¸b af valuta-->
    <table class="halfaccounttable">
        <tr class="totalbalance">
            <th> Total balance</th>
        </tr>
            <td> 
                <% 
                let totalDKK = 0;
                let totalUSD = 0;
                accounts.forEach(acc => { 
                  if (acc.currency === 'DKK') totalDKK += acc.balance;
                  if (acc.currency === 'USD') totalUSD += acc.balance;
                });
                %>
                
                <tr>
                  <td class="samletbalance"><%= totalDKK.toFixed(2) %> DKK</td>
                </tr>
                <tr>
                  <td class="samletbalance"><%= totalUSD.toFixed(2) %> USD</td>
                </tr>
        </td>
    </table>

          <div id="chartinUSDandDKK" 
          data-sumDKK="<%= totalDKK %>"
          data-sumUSD="<%= totalUSD %>"
          style="width:480px;height:320px;"></div>
   

    <script>
        let formopen = false

        const closeformbtn = document.getElementById('closeformbtn')
        const openformbtn = document.getElementById('openformbtn')
        const popupform = document.getElementById('popupform')

        function formpopup(){
            if(formopen){
                popupform.classList.add('hidden')
            } else {
                popupform.classList.remove('hidden')
            }
            formopen = !formopen
        }
        openformbtn.addEventListener('click', formpopup)
        closeformbtn.addEventListener('click', formpopup)

        window.addEventListener('click', temp => {
        if (temp.target === popupform) formpopup();
        });

     const chartDiv = echarts.init(document.getElementById('chartinUSDandDKK'))
      

          const sumDKK = Number(chartDiv.dataset.sumDKK);
          const sumUSD = Number(chartDiv.dataset.sumUSD);

        const option = {
        series: [
    {
      type: 'pie',
      radius: '50%',
      data: [
        {
          value: sumDKK,
          name: 'DKK'
        },
        {
          value: sumUSD,
          name: 'USD'
        },
      ],
    }]
};
chart.setOption(option)
    </script>
  </body>
</html>